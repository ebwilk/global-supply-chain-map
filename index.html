import React, { useState } from 'react';
import { AlertCircle, Ship, Box, Anchor, CheckCircle2, Menu, Bell, Search, User, Globe, Activity, X, ArrowRight, AlertTriangle, Clock } from 'lucide-react';

const FordLogisticsWidget = () => {
  const [activeTooltip, setActiveTooltip] = useState(null);
  const [selectedCategory, setSelectedCategory] = useState(null);

  // Mock Data for KPI Details
  const kpiDetails = {
    onTime: {
      title: "On Time Shipments",
      color: "green",
      items: [
        { id: "SH-2024-001", carrier: "Maersk", route: "Shanghai -> Long Beach", cargo: "Electronics", status: "On Schedule" },
        { id: "SH-2024-002", carrier: "Hapag-Lloyd", route: "Hamburg -> Newark", cargo: "Powertrain Components", status: "On Schedule" },
        { id: "SH-2024-003", carrier: "MSC", route: "Busan -> Seattle", cargo: "Body Panels", status: "Arriving Early" },
      ]
    },
    inTransit: {
      title: "Active Transit",
      color: "blue",
      items: [
        { id: "TR-8821", carrier: "HMM Algeciras", route: "Atlantic Route A", eta: "2 days", status: "Normal" },
        { id: "TR-9923", carrier: "ONE Apus", route: "Pacific Route B", eta: "5 days", status: "Normal" },
        { id: "TR-7712", carrier: "Ever Given", route: "Suez Canal", eta: "12 days", status: "Normal" },
      ]
    },
    atRisk: {
      title: "At Risk / Warning",
      color: "orange",
      items: [
        { id: "AR-101", location: "Taiwan Strait", issue: "Weather Delay", impact: "+12h ETA", material: "Semiconductors" },
        { id: "AR-102", location: "Veracruz Port", issue: "Customs Hold", impact: "Pending Release", material: "Seat Frames" },
        { id: "AR-103", location: "Rail Line B", issue: "Maintenance", impact: "+6h Delay", material: "Chassis Components" },
      ]
    },
    critical: {
      title: "Critical Disruptions",
      color: "red",
      items: [
        { id: "CR-99", location: "Rotterdam Port", issue: "Labor Strike (Active)", impact: "48h Stoppage", material: "Raw Materials B", action: "Reroute Required" }
      ]
    }
  };

  // Locations - Y coordinates tweaked slightly for the new map projection alignment
  const locations = [
    { id: 1, name: 'Dearborn HQ', x: 26, y: 34, status: 'normal', type: 'plant' },
    { id: 2, name: 'Valencia Plant', x: 48, y: 35, status: 'normal', type: 'plant' },
    { id: 3, name: 'Silverton Assembly', x: 55, y: 80, status: 'normal', type: 'plant' },
    { id: 4, name: 'Changan Ford', x: 78, y: 40, status: 'normal', type: 'plant' },
    { id: 5, name: 'San Luis Potosi', x: 22, y: 46, status: 'normal', type: 'supplier' },
    { id: 6, name: 'Chennai Plant', x: 68, y: 54, status: 'normal', type: 'plant' },
    { id: 7, name: 'Cologne Body & Assembly', x: 50, y: 30, status: 'normal', type: 'plant' },
    // The Alert Pin
    { 
      id: 99, 
      name: 'Rotterdam Port', 
      x: 49, 
      y: 30, 
      status: 'critical', 
      type: 'port',
      alertData: {
        title: 'Port Strike Alert',
        time: '48hr Delay Expected',
        impact: 'Raw Materials B'
      }
    },
  ];

  const handleKpiClick = (category) => {
    setSelectedCategory(selectedCategory === category ? null : category);
  };

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-800 p-4 md:p-8">
      
      {/* Dashboard Container - Relative for absolute positioning of modal */}
      <div className="max-w-7xl mx-auto bg-white rounded-xl shadow-xl overflow-hidden border border-slate-200 relative">
        
        {/* KPI Strip */}
        <div className="grid grid-cols-2 md:grid-cols-4 divide-x divide-slate-100 border-b border-slate-100 bg-white">
          
          <div 
            onClick={() => handleKpiClick('onTime')}
            className={`p-5 flex items-center gap-4 transition-all cursor-pointer group ${selectedCategory === 'onTime' ? 'bg-green-50/50 shadow-inner' : 'hover:bg-slate-50'}`}
          >
            <div className={`w-12 h-12 rounded-full flex items-center justify-center border transition-colors ${selectedCategory === 'onTime' ? 'bg-green-100 border-green-200 text-green-700' : 'bg-green-50 border-green-100 text-green-600'}`}>
              <CheckCircle2 className="w-6 h-6" />
            </div>
            <div>
              <p className="text-[11px] text-slate-400 uppercase tracking-widest font-bold group-hover:text-slate-600 transition-colors">On Time</p>
              <p className="text-2xl font-bold text-slate-800">1,248</p>
            </div>
          </div>

          <div 
            onClick={() => handleKpiClick('inTransit')}
            className={`p-5 flex items-center gap-4 transition-all cursor-pointer group ${selectedCategory === 'inTransit' ? 'bg-blue-50/50 shadow-inner' : 'hover:bg-slate-50'}`}
          >
            <div className={`w-12 h-12 rounded-full flex items-center justify-center border transition-colors ${selectedCategory === 'inTransit' ? 'bg-blue-100 border-blue-200 text-[#2D96CD]' : 'bg-blue-50 border-blue-100 text-[#2D96CD]'}`}>
              <Ship className="w-6 h-6" />
            </div>
            <div>
              <p className="text-[11px] text-slate-400 uppercase tracking-widest font-bold group-hover:text-slate-600 transition-colors">In Transit</p>
              <p className="text-2xl font-bold text-slate-800">432</p>
            </div>
          </div>

          <div 
            onClick={() => handleKpiClick('atRisk')}
            className={`p-5 flex items-center gap-4 transition-all cursor-pointer group ${selectedCategory === 'atRisk' ? 'bg-orange-50/50 shadow-inner' : 'hover:bg-slate-50'}`}
          >
            <div className={`w-12 h-12 rounded-full flex items-center justify-center border transition-colors ${selectedCategory === 'atRisk' ? 'bg-orange-100 border-orange-200 text-orange-700' : 'bg-orange-50 border-orange-100 text-orange-600'}`}>
              <Box className="w-6 h-6" />
            </div>
            <div>
              <p className="text-[11px] text-slate-400 uppercase tracking-widest font-bold group-hover:text-slate-600 transition-colors">At Risk</p>
              <p className="text-2xl font-bold text-slate-800">12</p>
            </div>
          </div>

          <div 
            onClick={() => handleKpiClick('critical')}
            className={`p-5 flex items-center gap-4 transition-all cursor-pointer group border-l-4 md:border-l-0 ${selectedCategory === 'critical' ? 'bg-red-50/80 shadow-inner border-l-[#D92C25]' : 'bg-red-50/30 hover:bg-red-50/50 border-l-[#D92C25]'}`}
          >
            <div className={`w-12 h-12 rounded-full flex items-center justify-center border animate-pulse transition-colors ${selectedCategory === 'critical' ? 'bg-red-200 border-red-300 text-[#D92C25]' : 'bg-red-100 border-red-200 text-[#D92C25]'}`}>
              <AlertCircle className="w-6 h-6" />
            </div>
            <div>
              <p className="text-[11px] text-[#D92C25] uppercase tracking-widest font-bold">Critical</p>
              <p className="text-2xl font-bold text-[#D92C25]">1</p>
            </div>
          </div>
        </div>

        {/* DETAILS OVERLAY MODAL */}
        {selectedCategory && (
            <div className="absolute top-[88px] left-0 right-0 bottom-0 z-50 bg-slate-900/10 backdrop-blur-sm p-4 flex justify-end animate-in fade-in duration-200">
                <div className="bg-white w-full max-w-md h-full rounded-xl shadow-2xl border border-slate-200 flex flex-col overflow-hidden animate-in slide-in-from-right duration-300">
                    
                    {/* Modal Header */}
                    <div className={`px-6 py-4 border-b flex justify-between items-center ${
                        selectedCategory === 'critical' ? 'bg-red-50 border-red-100' : 
                        selectedCategory === 'atRisk' ? 'bg-orange-50 border-orange-100' :
                        selectedCategory === 'inTransit' ? 'bg-blue-50 border-blue-100' : 'bg-green-50 border-green-100'
                    }`}>
                        <div>
                            <h3 className={`font-bold text-lg ${
                                selectedCategory === 'critical' ? 'text-red-700' : 
                                selectedCategory === 'atRisk' ? 'text-orange-700' :
                                selectedCategory === 'inTransit' ? 'text-blue-700' : 'text-green-700'
                            }`}>
                                {kpiDetails[selectedCategory].title}
                            </h3>
                            <p className="text-xs text-slate-500 mt-1">Real-time manifest data</p>
                        </div>
                        <button onClick={() => setSelectedCategory(null)} className="p-2 hover:bg-white/50 rounded-full transition-colors">
                            <X className="w-5 h-5 text-slate-500" />
                        </button>
                    </div>

                    {/* Modal Content List */}
                    <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50">
                        {kpiDetails[selectedCategory].items.map((item, idx) => (
                            <div key={idx} className="bg-white p-4 rounded-lg shadow-sm border border-slate-100 hover:shadow-md transition-shadow group">
                                <div className="flex justify-between items-start mb-2">
                                    <span className="text-[10px] font-mono text-slate-400 bg-slate-100 px-2 py-0.5 rounded">{item.id}</span>
                                    {selectedCategory === 'critical' && <span className="text-[10px] font-bold bg-red-100 text-red-700 px-2 py-0.5 rounded uppercase">Action Req</span>}
                                    {selectedCategory === 'atRisk' && <span className="text-[10px] font-bold bg-orange-100 text-orange-700 px-2 py-0.5 rounded uppercase">Warning</span>}
                                </div>
                                
                                <div className="mb-2">
                                    <h4 className="font-semibold text-slate-800 text-sm">
                                        {item.location || item.route || item.carrier}
                                    </h4>
                                    <p className="text-xs text-slate-500">
                                        {item.issue || item.cargo || "En Route"}
                                    </p>
                                </div>

                                {/* Dynamic Fields based on category */}
                                <div className="flex items-center gap-3 mt-3 pt-3 border-t border-slate-50">
                                    {(item.impact || item.eta) && (
                                        <div className="flex items-center gap-1.5">
                                            <Clock className="w-3.5 h-3.5 text-slate-400" />
                                            <span className="text-xs font-medium text-slate-700">{item.impact || item.eta}</span>
                                        </div>
                                    )}
                                    {item.material && (
                                        <div className="flex items-center gap-1.5">
                                            <Box className="w-3.5 h-3.5 text-slate-400" />
                                            <span className="text-xs font-medium text-slate-700">{item.material}</span>
                                        </div>
                                    )}
                                </div>
                                
                                {/* Action Button */}
                                <button className="w-full mt-3 text-xs font-medium py-2 rounded bg-slate-50 text-slate-600 hover:bg-[#00095B] hover:text-white transition-colors flex items-center justify-center gap-2">
                                    View Manifest <ArrowRight className="w-3 h-3" />
                                </button>
                            </div>
                        ))}
                        
                        {kpiDetails[selectedCategory].items.length === 0 && (
                            <div className="text-center py-10 text-slate-400">
                                <p>No items found in this category.</p>
                            </div>
                        )}
                    </div>
                    
                    {/* Modal Footer */}
                    <div className="p-4 bg-white border-t border-slate-100">
                        <button 
                            onClick={() => setSelectedCategory(null)}
                            className="w-full py-2 bg-white border border-slate-300 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-50 transition-colors"
                        >
                            Close Panel
                        </button>
                    </div>
                </div>
            </div>
        )}

        {/* Main Content Area */}
        <main className="p-6 relative bg-slate-50">
          
          <div className="flex justify-between items-end mb-4">
            <div>
              <div className="flex items-center gap-2 mb-1">
                <Globe className="w-4 h-4 text-[#2D96CD]" />
                <h2 className="text-lg font-bold text-[#00095B] tracking-tight">Global Network Intelligence</h2>
              </div>
              <p className="text-xs text-slate-500 font-medium">Live satellite tracking of Tier 1 supply chain.</p>
            </div>
            
            {/* Map Controls / Legend */}
            <div className="flex gap-3">
               <div className="flex items-center gap-2 bg-white px-3 py-1.5 rounded-md shadow-sm border border-slate-200">
                  <span className="w-2 h-2 rounded-full bg-[#3E8D62] shadow-[0_0_8px_rgba(62,141,98,0.6)]"></span> 
                  <span className="text-xs font-semibold text-slate-600">Optimal</span>
               </div>
               <div className="flex items-center gap-2 bg-white px-3 py-1.5 rounded-md shadow-sm border border-slate-200">
                  <span className="w-2 h-2 rounded-full bg-[#D92C25] animate-pulse shadow-[0_0_8px_rgba(217,44,37,0.6)]"></span> 
                  <span className="text-xs font-semibold text-slate-600">Disruption</span>
               </div>
            </div>
          </div>

          {/* SATELLITE COMMAND MAP WIDGET */}
          <div className="relative w-full aspect-[21/9] bg-[#020617] rounded-xl overflow-hidden shadow-2xl border border-slate-700 group isolation-auto">
            
            {/* 1. Base Map: Darkened Realistic Earth Texture */}
            {/* Using a high-quality NASA Blue Marble style texture for realism */}
            <div 
              className="absolute inset-0 bg-cover bg-center"
              style={{
                backgroundImage: `url('https://upload.wikimedia.org/wikipedia/commons/thumb/c/c3/Aurora_as_seen_by_IMAGE.jpg/1280px-Aurora_as_seen_by_IMAGE.jpg')`, 
                // We crop slightly to remove the sphere edges and focus on the landmass look
                backgroundSize: '110% 110%',
                backgroundPosition: 'center 40%',
                // Adjusting filters to make it look like a night-mode UI map
                filter: 'grayscale(30%) brightness(50%) contrast(110%) hue-rotate(190deg) saturate(150%)',
              }}
            ></div>

            {/* 2. Map Texture Overlay for Definition */}
            <div className="absolute inset-0 bg-[#00095B] mix-blend-color opacity-40"></div>
            
            {/* 3. Subtle Grid Lines for Scale */}
            <div 
                className="absolute inset-0 opacity-20 pointer-events-none"
                style={{
                    backgroundImage: 'linear-gradient(rgba(255, 255, 255, 0.2) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.2) 1px, transparent 1px)',
                    backgroundSize: '60px 60px'
                }}
            ></div>

            {/* 4. Simulated Shipping Lanes (Curved Lines) */}
            <svg className="absolute inset-0 w-full h-full pointer-events-none opacity-30">
               {/* Trans-Atlantic */}
               <path d="M 28% 35% Q 38% 30% 49% 30%" fill="none" stroke="#2D96CD" strokeWidth="1" strokeDasharray="4 4" />
               {/* Pacific */}
               <path d="M 78% 40% Q 95% 35% 99% 35%" fill="none" stroke="#2D96CD" strokeWidth="1" strokeDasharray="4 4" />
               <path d="M 0% 35% Q 10% 35% 26% 35%" fill="none" stroke="#2D96CD" strokeWidth="1" strokeDasharray="4 4" />
            </svg>

            {/* Pins Layer */}
            {locations.map((loc) => (
              <div
                key={loc.id}
                className="absolute transform -translate-x-1/2 -translate-y-1/2 cursor-pointer z-10"
                style={{ left: `${loc.x}%`, top: `${loc.y}%` }}
                onMouseEnter={() => loc.status === 'critical' ? setActiveTooltip(loc.id) : null}
                onMouseLeave={() => setActiveTooltip(null)}
              >
                {/* Critical Pin Style */}
                {loc.status === 'critical' ? (
                  <div className="relative">
                    {/* Radar Pulse Effect */}
                    <span className="absolute -inset-4 rounded-full border border-red-500/50 opacity-0 animate-ping"></span>
                    <span className="absolute -inset-8 rounded-full border border-red-500/30 opacity-0 animate-[ping_2s_cubic-bezier(0,0,0.2,1)_infinite]"></span>
                    
                    {/* The Pin Icon */}
                    <div className="relative flex items-center justify-center w-8 h-8 bg-[#D92C25] rounded-full shadow-[0_0_15px_rgba(217,44,37,0.8)] border border-white/20 text-white z-20 hover:scale-110 transition-transform">
                      <Anchor className="w-4 h-4" />
                    </div>

                    {/* Enhanced Tooltip */}
                    {activeTooltip === loc.id && (
                      <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-4 w-80 z-50">
                        <div className="bg-slate-900/95 backdrop-blur-md rounded-lg shadow-2xl border border-red-500/50 overflow-hidden text-white animate-in fade-in zoom-in duration-200">
                          {/* Header Strip */}
                          <div className="bg-gradient-to-r from-[#D92C25] to-red-900 px-4 py-2 flex justify-between items-center">
                             <div className="flex items-center gap-2">
                                <Activity className="w-3 h-3 text-white animate-pulse" />
                                <span className="text-xs font-bold uppercase tracking-widest">Active Alert</span>
                             </div>
                             <span className="text-[10px] font-mono bg-black/20 px-2 py-0.5 rounded">ERR_PORT_99</span>
                          </div>
                          
                          <div className="p-5">
                            <h4 className="text-lg font-bold mb-1 leading-tight">{loc.alertData.title}</h4>
                            <p className="text-xs text-red-200 mb-4 uppercase tracking-wide opacity-80">Rotterdam Terminal 4</p>
                            
                            <div className="space-y-3 bg-white/5 rounded p-3 border border-white/10">
                                <div className="flex justify-between items-center border-b border-white/10 pb-2">
                                    <span className="text-xs text-slate-400">Est. Delay</span>
                                    <span className="text-sm font-bold text-red-400 font-mono">48h 00m</span>
                                </div>
                                <div className="flex justify-between items-center">
                                    <span className="text-xs text-slate-400">Impact</span>
                                    <span className="text-sm font-medium text-white">{loc.alertData.impact}</span>
                                </div>
                            </div>

                            <div className="mt-4 flex gap-2">
                                <button className="flex-1 bg-white text-[#00095B] text-xs font-bold py-2 rounded hover:bg-slate-200 transition-colors shadow-lg">
                                    REROUTE
                                </button>
                                <button className="flex-1 bg-transparent border border-white/30 text-white text-xs font-medium py-2 rounded hover:bg-white/10 transition-colors">
                                    DETAILS
                                </button>
                            </div>
                          </div>
                        </div>
                        {/* Tooltip Connector */}
                        <div className="w-px h-4 bg-red-500 absolute left-1/2 -translate-x-1/2 -bottom-4"></div>
                      </div>
                    )}
                  </div>
                ) : (
                  /* Standard Green Pin - Neon Style */
                  <div className="group/pin relative flex items-center justify-center">
                    <div className="w-2 h-2 bg-[#4ade80] rounded-full shadow-[0_0_10px_#4ade80] z-10"></div>
                    <div className="absolute w-4 h-4 bg-[#4ade80] rounded-full opacity-20 animate-pulse"></div>
                    
                    {/* Hover Label */}
                    <div className="absolute top-6 left-1/2 -translate-x-1/2 opacity-0 group-hover/pin:opacity-100 transition-all duration-300 transform translate-y-2 group-hover/pin:translate-y-0 pointer-events-none">
                       <div className="bg-slate-900 text-white text-[10px] whitespace-nowrap px-2 py-1 rounded border border-slate-700 shadow-xl font-medium tracking-wide">
                          {loc.name}
                       </div>
                    </div>
                  </div>
                )}
              </div>
            ))}

            {/* Map Decorative UI Elements */}
            <div className="absolute bottom-4 left-6 text-white/50 font-mono text-[10px]">
                LAT: 51.9244° N <br/> LON: 4.4777° E
            </div>
            <div className="absolute top-4 right-6 flex items-center gap-2">
                <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                <span className="text-green-400 font-mono text-[10px] tracking-wider">LIVE FEED</span>
            </div>
          </div>
          
          {/* Map Footer Information */}
          <div className="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
             <div className="bg-white p-4 rounded-lg border border-slate-200 shadow-sm hover:shadow-md transition-shadow cursor-pointer group">
                <div className="flex justify-between items-start">
                    <div>
                        <h4 className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Route Atlantic</h4>
                        <div className="flex items-center gap-2 text-[#00095B]">
                            <Ship className="w-4 h-4" />
                            <span className="text-sm font-bold">HMM Algeciras</span>
                        </div>
                    </div>
                    <div className="bg-green-100 text-green-700 text-[10px] font-bold px-2 py-1 rounded">ON TIME</div>
                </div>
                <div className="mt-3 w-full bg-slate-100 h-1.5 rounded-full overflow-hidden">
                    <div className="bg-[#2D96CD] h-full w-[70%] group-hover:animate-pulse"></div>
                </div>
             </div>

             <div className="bg-white p-4 rounded-lg border border-slate-200 shadow-sm hover:shadow-md transition-shadow cursor-pointer group">
                <div className="flex justify-between items-start">
                    <div>
                        <h4 className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Route Pacific</h4>
                        <div className="flex items-center gap-2 text-[#00095B]">
                            <Ship className="w-4 h-4" />
                            <span className="text-sm font-bold">ONE Apus</span>
                        </div>
                    </div>
                    <div className="bg-green-100 text-green-700 text-[10px] font-bold px-2 py-1 rounded">ON TIME</div>
                </div>
                <div className="mt-3 w-full bg-slate-100 h-1.5 rounded-full overflow-hidden">
                    <div className="bg-[#2D96CD] h-full w-[45%] group-hover:animate-pulse"></div>
                </div>
             </div>

             <div className="bg-red-50 p-4 rounded-lg border border-red-100 shadow-sm flex flex-col justify-between hover:border-red-200 transition-colors cursor-pointer">
                <div className="flex items-start gap-3">
                    <AlertCircle className="w-5 h-5 text-[#D92C25] shrink-0" />
                    <div>
                        <h4 className="text-sm font-bold text-[#D92C25] leading-tight">Rotterdam Strike Update</h4>
                        <p className="text-xs text-red-700 mt-1">Negotiations stalled. 48hr delay confirmed for incoming freight.</p>
                    </div>
                </div>
                <div className="mt-3 flex items-center justify-between">
                    <span className="text-[10px] font-bold text-red-400 uppercase">Updated 10m ago</span>
                    <span className="text-xs font-bold text-[#D92C25] flex items-center gap-1 group">
                        View Plan <span className="group-hover:translate-x-1 transition-transform">→</span>
                    </span>
                </div>
             </div>
          </div>

        </main>
      </div>
    </div>
  );
};

export default FordLogisticsWidget;
